name: Publish Article from Issue

on:
  issues:
    types: [opened, edited]

jobs:
  publish-article:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'article')
    permissions:
      contents: write
      issues: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
        
    - name: Parse issue and generate article
      id: parse-issue
      run: |
        node .github/scripts/parse-issue.js
      env:
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        
    - name: Generate article files
      run: |
        node .github/scripts/generate-article.js
      env:
        ARTICLE_DATA: ${{ steps.parse-issue.outputs.article-data }}
        
    - name: Update article indexes
      run: |
        node .github/scripts/update-indexes.js
      env:
        ARTICLE_DATA: ${{ steps.parse-issue.outputs.article-data }}
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Publish article from issue #${{ github.event.issue.number }}"
          git push
        fi
        
    - name: Comment on issue
      uses: actions/github-script@v7
      with:
        script: |
          const articleData = JSON.parse(process.env.ARTICLE_DATA);
          const comment = `âœ… Article published successfully!
          
          **Article URL:** https://kevinsundstrom.com${articleData.url}
          **Category:** ${articleData.category}
          
          The article has been automatically generated and published to the website.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      env:
        ARTICLE_DATA: ${{ steps.parse-issue.outputs.article-data }}