name: Multi-Agent Content Workflow

# Trigger when a new brief is added or modified
on:
  push:
    paths:
      - 'content-workflow/briefs/*.md'
      - '!content-workflow/briefs/TEMPLATE-content-brief.md'
  workflow_dispatch:
    inputs:
      brief_file:
        description: 'Brief file name (e.g., my-article-brief.md)'
        required: true
        type: string
      skip_review:
        description: 'Skip editorial review step'
        required: false
        type: boolean
        default: false

jobs:
  # Job 1: Content Writer Agent - Generate draft from brief
  generate-draft:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    outputs:
      brief-slug: ${{ steps.identify-brief.outputs.brief-slug }}
      draft-file: ${{ steps.generate.outputs.draft-file }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history for better context
    
    - name: Identify brief file
      id: identify-brief
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # Manual trigger with specific brief
          BRIEF_FILE="${{ github.event.inputs.brief_file }}"
        else
          # Automatic trigger from push - find the modified brief
          BRIEF_FILE=$(git diff --name-only HEAD^ HEAD | grep 'content-workflow/briefs/' | grep -v TEMPLATE | head -1)
        fi
        
        if [ -z "$BRIEF_FILE" ]; then
          echo "No brief file found"
          exit 1
        fi
        
        echo "Processing brief: $BRIEF_FILE"
        
        # Extract slug from filename
        BRIEF_SLUG=$(basename "$BRIEF_FILE" .md)
        echo "brief-slug=$BRIEF_SLUG" >> $GITHUB_OUTPUT
        echo "brief-file=$BRIEF_FILE" >> $GITHUB_OUTPUT
    
    - name: Setup GitHub Copilot CLI
      run: |
        # Note: This is a placeholder for actual Copilot CLI setup
        # Replace with actual setup steps for your environment
        echo "Setting up Copilot CLI..."
        # gh extension install github/gh-copilot
    
    - name: Generate content draft
      id: generate
      run: |
        BRIEF_FILE="${{ steps.identify-brief.outputs.brief-file }}"
        BRIEF_SLUG="${{ steps.identify-brief.outputs.brief-slug }}"
        DATE=$(date +%Y%m%d)
        DRAFT_FILE="content-workflow/outputs/${BRIEF_SLUG}-draft-${DATE}.md"
        METADATA_FILE="content-workflow/outputs/${BRIEF_SLUG}-metadata-${DATE}.yml"
        
        echo "Generating draft from $BRIEF_FILE..."
        
        # Placeholder for actual agent invocation
        # In production, this would call your Content Writer agent
        # For now, create placeholder files
        
        cat > "$DRAFT_FILE" << 'EOF'
        # Draft Generated by Content Writer Agent
        
        This is a placeholder draft. In production, this would be generated by the Content Writer agent
        based on the brief, style guide, and brand guidelines.
        
        The agent would:
        1. Read and analyze the brief
        2. Consult style guide and brand guidelines
        3. Generate structured content with proper headers
        4. Include examples and practical value
        5. Ensure SEO optimization
        EOF
        
        cat > "$METADATA_FILE" << 'EOF'
        title: "Generated Article Title"
        description: "Generated meta description"
        keywords: "keyword1, keyword2, keyword3"
        category: "General"
        author: "Kevin Sundstrom"
        date: "2026-02-13"
        EOF
        
        echo "draft-file=$DRAFT_FILE" >> $GITHUB_OUTPUT
        echo "metadata-file=$METADATA_FILE" >> $GITHUB_OUTPUT
    
    - name: Commit draft outputs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add content-workflow/outputs/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Generate content draft for ${{ steps.identify-brief.outputs.brief-slug }}"
          git push
        fi

  # Job 2: Content Editor Agent - Review and refine draft
  review-draft:
    runs-on: ubuntu-latest
    needs: generate-draft
    if: github.event.inputs.skip_review != 'true'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Pull latest changes
      run: |
        git pull origin ${{ github.ref_name }}
    
    - name: Setup GitHub Copilot CLI
      run: |
        echo "Setting up Copilot CLI..."
        # gh extension install github/gh-copilot
    
    - name: Review and edit draft
      id: review
      run: |
        BRIEF_SLUG="${{ needs.generate-draft.outputs.brief-slug }}"
        DRAFT_FILE="${{ needs.generate-draft.outputs.draft-file }}"
        DATE=$(date +%Y%m%d)
        FINAL_FILE="content-workflow/outputs/${BRIEF_SLUG}-final-${DATE}.md"
        REVIEW_NOTES="content-workflow/outputs/${BRIEF_SLUG}-review-notes-${DATE}.md"
        
        echo "Reviewing draft: $DRAFT_FILE"
        
        # Placeholder for actual agent invocation
        # In production, this would call your Content Editor agent
        
        if [ -f "$DRAFT_FILE" ]; then
          cp "$DRAFT_FILE" "$FINAL_FILE"
          
          cat > "$REVIEW_NOTES" << 'EOF'
        # Editorial Review Notes
        
        ## Summary
        Draft has been reviewed and prepared for publication.
        
        ## Changes Made
        - Placeholder: In production, this would list actual edits
        
        ## Status
        ‚úÖ Ready for publication
        EOF
        else
          echo "Draft file not found: $DRAFT_FILE"
          exit 1
        fi
        
        echo "final-file=$FINAL_FILE" >> $GITHUB_OUTPUT
        echo "review-notes=$REVIEW_NOTES" >> $GITHUB_OUTPUT
    
    - name: Commit reviewed content
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add content-workflow/outputs/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Editorial review complete for ${{ needs.generate-draft.outputs.brief-slug }}"
          git push
        fi
    
    - name: Create summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ‚úÖ Multi-Agent Content Workflow Complete
        
        ### Brief Processed
        - **Slug**: ${{ needs.generate-draft.outputs.brief-slug }}
        - **Draft**: ${{ needs.generate-draft.outputs.draft-file }}
        - **Final**: ${{ steps.review.outputs.final-file }}
        
        ### Next Steps
        1. Review the final content in the outputs folder
        2. Use the publish-article workflow or manual process to publish
        3. Archive the brief and outputs as needed
        
        EOF

  # Job 3: Notify completion
  notify:
    runs-on: ubuntu-latest
    needs: [generate-draft, review-draft]
    if: always()
    permissions:
      issues: write
    
    steps:
    - name: Find related issue
      id: find-issue
      uses: actions/github-script@v7
      with:
        script: |
          const briefSlug = '${{ needs.generate-draft.outputs.brief-slug }}';
          
          // Search for issues mentioning this brief
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'content-brief'
          });
          
          // Find issue that mentions the brief file
          const relatedIssue = issues.data.find(issue => 
            issue.body && issue.body.includes(briefSlug)
          );
          
          if (relatedIssue) {
            core.setOutput('issue-number', relatedIssue.number);
          }
          return relatedIssue?.number || null;
    
    - name: Comment on issue
      if: steps.find-issue.outputs.issue-number
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = ${{ steps.find-issue.outputs.issue-number }};
          const briefSlug = '${{ needs.generate-draft.outputs.brief-slug }}';
          const draftFile = '${{ needs.generate-draft.outputs.draft-file }}';
          
          const success = '${{ needs.review-draft.result }}' === 'success';
          
          let comment = success ? 
            `‚úÖ **Content workflow completed successfully!**
            
            Your brief has been processed by the multi-agent workflow:
            
            - üìù **Draft generated** by Content Writer agent
            - ‚úèÔ∏è **Editorial review** completed by Content Editor agent
            - üìÅ **Outputs available** in \`content-workflow/outputs/\`
            
            ### Files Generated
            - Draft: \`${draftFile}\`
            - Review notes available in outputs folder
            
            ### Next Steps
            1. Review the final content
            2. Publish using the article publishing workflow
            3. Close this issue once published
            ` :
            `‚ö†Ô∏è **Content workflow completed with issues**
            
            The workflow encountered some issues. Please check the workflow logs for details.
            
            Brief: \`${briefSlug}\`
            `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            body: comment
          });
